<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statystyki - Prezentownik</title>
    
    <!-- Force cache refresh for users with old version -->
    <script>
        (function() {
            const PAGE_VERSION = '2.0.0'; // Increment this when making breaking changes
            const storedVersion = localStorage.getItem('homePageVersion');
            
            if (storedVersion !== PAGE_VERSION) {
                console.log('New version detected, clearing cache...');
                localStorage.setItem('homePageVersion', PAGE_VERSION);
                
                // Only reload once to prevent infinite loop
                if (!sessionStorage.getItem('homePageReloaded')) {
                    sessionStorage.setItem('homePageReloaded', 'true');
                    window.location.reload(true);
                }
            }
        })();
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles.deduped.min.css">
    <link href="bottom-tab-bar.css?v=15" rel="stylesheet">
    <style>
        body {
            background: url('seba.jpg') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent !important;
            backdrop-filter: none !important;
            z-index: -1;
        }

        .stats-navbar {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
            padding: 1rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .stats-navbar .container-fluid {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-navbar .navbar-brand {
            margin: 0 auto;
        }

        .stats-navbar .brand-text {
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            font-size: 1.25rem;
            font-weight: 600;
        }

        .stats-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-container h3 {
            color: white !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 4px 16px rgba(0, 0, 0, 0.3) !important;
            text-align: center !important;
        }

        @media (max-width: 768px) {
            .stats-container {
                padding: 20px;
                margin: 15px auto;
            }
        }
    </style>
</head>

<body class="has-tab-bar">
    <div class="background-overlay"></div>

    <nav class="navbar navbar-expand-lg navbar-dark stats-navbar">
        <div class="container-fluid">
            <div class="navbar-brand">
                <div class="brand-container" style="display: flex; align-items: center; gap: 15px;">
                    <div class="brand-logo-container">
                        <img src="seba_logo.png" alt="Logo" style="width: 40px; height: 40px; border-radius: 8px;">
                    </div>
                    <span class="brand-text">
                        <i class="fas fa-chart-bar me-2"></i>Statystyki
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Cumulative Progress Bars -->
        <div id="cumulativeProgressSection" class="stats-container">
            <h3 style="color: #2d3748; font-weight: 700; margin-bottom: 20px; text-align: center;">
                <i class="fas fa-chart-line me-2"></i>Og贸lny Postp
            </h3>
            <!-- Buying Progress -->
            <div style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="font-weight: 600; color: #2d3748; margin: 0; font-size: 16px;">
                        <i class="fas fa-shopping-bag" style="color: #4CAF50; margin-right: 8px;"></i>Kupione Prezenty
                    </label>
                    <span id="boughtStats" style="font-weight: 600; color: #4CAF50; font-size: 16px;">0/0</span>
                </div>
                <div style="background: #e0e0e0; border-radius: 10px; height: 14px; overflow: hidden;">
                    <div id="boughtProgressBar"
                        style="background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; width: 0%; transition: width 0.5s ease;">
                    </div>
                </div>
            </div>
            <!-- Reserved vs Available Progress -->
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="font-weight: 600; color: #2d3748; margin: 0; font-size: 16px;">
                        <i class="fas fa-bookmark" style="color: #FF9800; margin-right: 8px;"></i>Zarezerwowane Prezenty
                    </label>
                    <span id="reservedStats" style="font-weight: 600; color: #FF9800; font-size: 16px;">0/0</span>
                </div>
                <div style="background: #e0e0e0; border-radius: 10px; height: 14px; overflow: hidden; display: flex;">
                    <div id="reservedProgressBar"
                        style="background: linear-gradient(90deg, #FF9800, #F57C00); height: 100%; width: 0%; transition: width 0.5s ease;">
                    </div>
                    <div id="availableProgressBar" style="background: #c0c0c0; height: 100%; flex: 1;"></div>
                </div>
            </div>
        </div>

        <!-- My Profile Card -->
        <div id="myProfileSection" class="stats-container" style="display: none;">
            <div class="accordion" id="accordionProfile">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProfile" aria-expanded="true" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                            <i class="fas fa-user-circle me-2"></i>M贸j Profil
                        </button>
                    </h2>
                    <div id="collapseProfile" class="accordion-collapse collapse show" data-bs-parent="#accordionProfile">
                        <div class="accordion-body" style="padding: 0;">
                            <div id="myProfileCard">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">adowanie...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Presents List -->
        <div id="availablePresentsSection" class="stats-container">
            <div class="accordion" id="accordionAvailable">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAvailable" aria-expanded="true" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; font-weight: 600;">
                            <i class="fas fa-gifts me-2"></i>Dostpne Prezenty
                        </button>
                    </h2>
                    <div id="collapseAvailable" class="accordion-collapse collapse show" data-bs-parent="#accordionAvailable">
                        <div class="accordion-body" style="padding: 0;">
                            <div id="availablePresentsList">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">adowanie...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Reservations -->
        <div id="myReservationsSection" class="stats-container">
            <div class="accordion" id="accordionReservations">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReservations" aria-expanded="true" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; font-weight: 600;">
                            <i class="fas fa-bookmark me-2"></i>Moje Rezerwacje
                        </button>
                    </h2>
                    <div id="collapseReservations" class="accordion-collapse collapse show" data-bs-parent="#accordionReservations">
                        <div class="accordion-body" style="padding: 0;">
                            <div id="myReservationsList">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">adowanie...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bought Presents -->
        <div id="boughtPresentsSection" class="stats-container">
            <div class="accordion" id="accordionBought">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBought" aria-expanded="true" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; font-weight: 600;">
                            <i class="fas fa-check-circle me-2"></i>Kupione
                        </button>
                    </h2>
                    <div id="collapseBought" class="accordion-collapse collapse show" data-bs-parent="#accordionBought">
                        <div class="accordion-body" style="padding: 0;">
                            <div id="boughtPresentsList">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">adowanie...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Fast loader (load first for instant cache access) -->
    <script src="fast-loader.js"></script>

    <script>
        // Flag to prevent recipients.js from auto-initializing
        window.SKIP_RECIPIENTS_INIT = true;

        // Set current user ID for recipients.js functions
        window._currentUserId = null;
    </script>

    <!-- Load recipients.js for shared functions (but don't auto-init) -->
    <script src="recipients.js?v=7&t=1111111111"></script>

    <!-- Non-critical scripts (defer to load after page is interactive) -->
    <script src="update-checker.js" defer></script>
    <script src="realtime-updates.js" defer></script>

    <script>
        // Check authentication
        function checkAuth() {
            return fetch('/api/auth', {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.authenticated) {
                        console.warn('User not authenticated, redirecting to login');
                        window.location.href = '/';
                        throw new Error('Not authenticated');
                    }
                    // Set current user ID for recipients.js functions
                    window._currentUserId = data.user.id;
                    return data.user;
                })
                .catch(error => {
                    console.error('Auth check error:', error);
                    throw error;
                });
        }

        // Check auth on page load
        checkAuth().then(() => {
            console.log('User authenticated, loading stats');
            loadStats();
            loadMyProfile();
            
            // Check identification status and show modal if needed
            checkIdentificationStatus();
        }).catch(() => {
            console.log('Auth failed, redirecting to login');
        });
        
        // Check if user needs to identify themselves
        function checkIdentificationStatus() {
            Promise.all([
                fetch('/api/recipients').then(r => r.json()),
                fetch('/api/user/identification').then(r => r.json())
            ]).then(([recipients, identificationStatus]) => {
                // Call the identification logic from recipients.js
                if (typeof window.checkAndPromptIdentification === 'function') {
                    window.checkAndPromptIdentification(recipients, identificationStatus);
                } else {
                    // Fallback: manually check and show modal
                    const alreadyIdentified = recipients.find(r => r.identified_by === window._currentUserId);
                    
                    if (!alreadyIdentified && !identificationStatus.isIdentified) {
                        const matchingRecipient = recipients.find(r =>
                            r.name.toLowerCase() === identificationStatus.username?.toLowerCase() &&
                            !r.identified_by
                        );
                        
                        if (matchingRecipient) {
                            setTimeout(() => {
                                if (typeof identifyAsRecipient === 'function') {
                                    identifyAsRecipient(matchingRecipient.id, matchingRecipient.name, true);
                                }
                            }, 500);
                        } else {
                            setTimeout(() => {
                                if (typeof showRecipientSelectionModal === 'function') {
                                    showRecipientSelectionModal();
                                }
                            }, 500);
                        }
                    }
                }
            }).catch(error => {
                console.error('Error checking identification:', error);
            });
        }
    </script>

    <script>
        function getEmojiAvatar(name) {
            const emojis = ['', '', '', '', '', '', '', '', 'コ', '', '', 'ぉ', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
            const index = name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % emojis.length;
            return emojis[index];
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/leaderboard');
                const data = await response.json();

                if (data.cumulativeStats) {
                    updateCumulativeProgress(data.cumulativeStats);
                }

                loadAvailablePresents();
                loadMyReservations();
                loadBoughtPresents();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateCumulativeProgress(cumulativeStats) {
            const totalPresents = cumulativeStats.totalPresents || 0;
            const totalBought = cumulativeStats.boughtPresents || 0;
            const totalReserved = cumulativeStats.reservedPresents || 0;

            const boughtPercent = totalPresents > 0 ? Math.round((totalBought / totalPresents) * 100) : 0;
            const reservedPercent = totalPresents > 0 ? Math.round((totalReserved / totalPresents) * 100) : 0;

            document.getElementById('boughtStats').textContent = `${totalBought}/${totalPresents}`;
            document.getElementById('boughtProgressBar').style.width = `${boughtPercent}%`;

            document.getElementById('reservedStats').textContent = `${totalReserved}/${totalPresents}`;
            document.getElementById('reservedProgressBar').style.width = `${reservedPercent}%`;
        }

        function loadMyProfile() {
            Promise.all([
                fetch('/api/recipients-with-presents').then(r => r.json()),
                fetch('/api/user/identification').then(r => r.json())
            ])
                .then(([data, identificationStatus]) => {
                    if (!identificationStatus.isIdentified) {
                        // User not identified, hide profile section
                        document.getElementById('myProfileSection').style.display = 'none';
                        return;
                    }

                    const presents = data.presents || [];
                    const recipients = data.recipients || [];
                    const identifiedRecipient = recipients.find(r => r.identified_by === identificationStatus.userId);

                    if (!identifiedRecipient) {
                        document.getElementById('myProfileSection').style.display = 'none';
                        return;
                    }

                    // Show profile section
                    document.getElementById('myProfileSection').style.display = 'block';

                    // Get user's own presents
                    const ownPresents = presents.filter(p => 
                        p.recipient_id === identifiedRecipient.id && 
                        p.created_by === identificationStatus.userId
                    );

                    renderMyProfile(identifiedRecipient, ownPresents);
                })
                .catch(error => console.error('Error loading profile:', error));
        }

        function renderMyProfile(recipient, ownPresents) {
            const container = document.getElementById('myProfileCard');
            
            const avatarHTML = recipient.profile_picture
                ? `<img src="/api/recipients/${recipient.id}/profile-picture" 
                       alt="${escapeHtml(recipient.name)}" 
                       style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                       onclick="openProfilePicturePreview(${recipient.id}, '${escapeHtml(recipient.name).replace(/'/g, "\\'")}', '/api/recipients/${recipient.id}/profile-picture')"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                   <div style="display: none; width: 80px; height: 80px; align-items: center; justify-content: center; font-size: 3rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                       ${getEmojiAvatar(recipient.name)}
                   </div>`
                : `<div style="display: flex; width: 80px; height: 80px; align-items: center; justify-content: center; font-size: 3rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                       ${getEmojiAvatar(recipient.name)}
                   </div>`;

            container.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px;">
                        ${avatarHTML}
                        <h4 style="color: #2d3748; font-weight: 600; margin-top: 15px; margin-bottom: 8px;">${escapeHtml(recipient.name)}</h4>
                        <p style="color: #718096; margin: 0;">
                            <i class="fas fa-gift me-1"></i>${ownPresents.length} ${ownPresents.length === 1 ? 'prezent' : 'prezent贸w'}
                        </p>
                    </div>
                    
                    <div class="accordion" id="accordionOwnPresents">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOwnPresents" 
                                    style="background-color: #cfe2ff; color: #084298; font-weight: 600;">
                                    <i class="fas fa-gift me-2"></i>
                                    Twoje prezenty (${ownPresents.length}) - kliknij aby edytowa
                                </button>
                            </h2>
                            <div id="collapseOwnPresents" class="accordion-collapse collapse">
                                <div class="accordion-body" style="background: linear-gradient(135deg, #cfe2ff 0%, #9ec5fe 100%);">
                                    <div class="alert alert-info mb-3" style="border-left: 4px solid #0d6efd;">
                                        <strong> Niespodzianka!</strong><br>
                                        Nie mo偶esz zobaczy kt贸re z Twoich prezent贸w zostay zarezerwowane albo zakupione. Chyba nie chcesz sobie zepsu niespodzianki!
                                    </div>
                                    ${ownPresents.length > 0 ? `
                                        <div class="fw-bold mb-2"><i class="fas fa-list me-1"></i>Twoje dodane prezenty:</div>
                                        <ul class="list-group">
                                            ${ownPresents.map(p => `
                                                <li class="list-group-item">
                                                    <div class="d-flex align-items-start justify-content-between gap-2 flex-wrap">
                                                        <div class="flex-grow-1">
                                                            <div class="fw-semibold">${escapeHtml(p.title)}</div>
                                                            ${p.comments ? `<div class="text-muted small mt-1"><i class="fas fa-info-circle me-1"></i>${escapeHtml(p.comments)}</div>` : ''}
                                                        </div>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-primary edit-present-btn-profile" style="min-width:50px;" 
                                                                data-present-id="${p.id}"
                                                                data-present-title="${escapeHtml(p.title)}"
                                                                data-recipient-id="${p.recipient_id}"
                                                                data-present-comments="${escapeHtml(p.comments || '')}">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-danger delete-present-btn-profile" style="min-width:50px;" 
                                                                data-present-id="${p.id}"
                                                                data-present-title="${escapeHtml(p.title)}">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : '<p class="text-muted mb-0">Nie dodae jeszcze 偶adnych prezent贸w.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Event delegation for edit and delete buttons in profile
        document.addEventListener('click', function(e) {
            // Edit button
            if (e.target.closest('.edit-present-btn-profile')) {
                const btn = e.target.closest('.edit-present-btn-profile');
                const presentId = btn.dataset.presentId;
                const title = btn.dataset.presentTitle;
                const recipientId = btn.dataset.recipientId;
                const comments = btn.dataset.presentComments;
                
                // Use the editPresent function from recipients.js if available
                if (typeof editPresent === 'function') {
                    editPresent(presentId, title, recipientId, comments);
                } else {
                    // Fallback: redirect to formularz with edit parameter
                    window.location.href = `formularz.html?edit=${presentId}`;
                }
            }
            
            // Delete button
            if (e.target.closest('.delete-present-btn-profile')) {
                const btn = e.target.closest('.delete-present-btn-profile');
                const presentId = btn.dataset.presentId;
                const title = btn.dataset.presentTitle;
                
                if (!confirm(`Czy na pewno chcesz usun prezent "${title}"?`)) {
                    return;
                }

                fetch(`/api/presents/${presentId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload profile to show updated list
                            loadMyProfile();
                            loadStats();
                        } else {
                            alert('Bd: ' + (data.error || 'Nie udao si usun prezentu'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Wystpi bd podczas usuwania prezentu');
                    });
            }
        });

        function loadAvailablePresents() {
            Promise.all([
                fetch('/api/recipients-with-presents').then(r => r.json()),
                fetch('/api/user/identification').then(r => r.json())
            ])
                .then(([data, identificationStatus]) => {
                    const presents = data.presents || [];
                    const recipients = data.recipients || [];

                    const identifiedRecipientId = identificationStatus.isIdentified ?
                        recipients.find(r => r.identified_by === identificationStatus.userId)?.id : null;

                    const availablePresents = presents.filter(p =>
                        !p.reserved_by &&
                        !p.is_checked &&
                        p.recipient_id !== identifiedRecipientId
                    );

                    renderAvailablePresents(availablePresents, recipients);
                })
                .catch(error => console.error('Error loading presents:', error));
        }

        function renderAvailablePresents(presents, recipients) {
            const container = document.getElementById('availablePresentsList');

            if (presents.length === 0) {
                container.innerHTML = '<div class="text-center py-5"><p class="text-muted">Brak dostpnych prezent贸w</p></div>';
                return;
            }

            const presentsByRecipient = {};
            presents.forEach(present => {
                if (!presentsByRecipient[present.recipient_id]) {
                    presentsByRecipient[present.recipient_id] = [];
                }
                presentsByRecipient[present.recipient_id].push(present);
            });

            let html = '';
            Object.keys(presentsByRecipient).forEach(recipientId => {
                const recipient = recipients.find(r => r.id == recipientId);
                if (!recipient) return;

                const recipientPresents = presentsByRecipient[recipientId];

                const avatarHTML = recipient.profile_picture
                    ? `<img src="/api/recipients/${recipient.id}/profile-picture" 
                           alt="${escapeHtml(recipient.name)}" 
                           style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer;"
                           onclick="openProfilePicturePreview(${recipient.id}, '${escapeHtml(recipient.name).replace(/'/g, "\\'")}', '/api/recipients/${recipient.id}/profile-picture')"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div style="display: none; width: 40px; height: 40px; align-items: center; justify-content: center; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; flex-shrink: 0;">
                           ${getEmojiAvatar(recipient.name)}
                       </div>`
                    : `<div style="display: flex; width: 40px; height: 40px; align-items: center; justify-content: center; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; flex-shrink: 0;">
                           ${getEmojiAvatar(recipient.name)}
                       </div>`;

                html += `
                    <div style="margin-bottom: 25px; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h5 style="color: #2d3748; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            ${avatarHTML}
                            ${escapeHtml(recipient.name)}
                            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 500;">
                                ${recipientPresents.length} ${recipientPresents.length === 1 ? 'prezent' : 'prezent贸w'}
                            </span>
                        </h5>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${recipientPresents.map(present => `
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #ffcc00;">
                                    <div style="flex: 1; min-width: 0; display: flex; gap: 8px;">
                                        <i class="fas fa-gift" style="color:  #ffcc00; margin-top: 2px; flex-shrink: 0;"></i>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 500; color: #2d3748; margin-bottom: 4px; word-wrap: break-word; overflow-wrap: break-word;">
                                                ${makeLinksClickable(escapeHtml(present.title))}
                                            </div>
                                            ${present.comments ? `
                                                <div style="font-size: 13px; color: #718096; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">
                                                    ${makeLinksClickable(escapeHtml(present.comments))}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm" onclick="reservePresent(event, ${present.id})" style="white-space: nowrap; padding: 6px 16px; font-size: 13px; flex-shrink: 0; color: #ffcc00; border-color: #ffc107; border: 2px solid #ffcc00;">
                                        <i class="fas fa-bookmark me-1"></i>Zarezerwuj
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function makeLinksClickable(text) {
            const urlPattern = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/g;
            const urls = [];
            let match;
            while ((match = urlPattern.exec(text)) !== null) {
                urls.push(match[1]);
            }

            if (urls.length > 0) {
                // Remove URLs from text
                let textOnly = text;
                urls.forEach(url => {
                    textOnly = textOnly.replace(url, '');
                });

                // Clean up extra whitespace
                textOnly = textOnly.trim().replace(/\s+/g, ' ');

                // Create links list with li style
                const linksList = urls.map(url => {
                    let cleanUrl = url.replace(/[.,;:!?)]+$/, '');
                    let displayText = cleanUrl;
                    if (cleanUrl.length > 60) {
                        displayText = cleanUrl.substring(0, 57) + '...';
                    }
                    return `<li style="margin: 4px 0; padding-left: 0; display: flex; align-items: flex-start;"><span style="margin-right: 4px; flex-shrink: 0;"></span><a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" style="color: #2196F3; text-decoration: underline; word-break: break-all;">${escapeHtml(displayText)}</a></li>`;
                }).join('');

                const urlList = `<ul style="margin: 8px 0 8px 0; padding-left: 0; list-style: none;">${linksList}</ul>`;

                if (textOnly) {
                    return textOnly + '<br>' + urlList;
                } else {
                    return urlList;
                }
            }

            return text;
        }

        function loadMyReservations() {
            Promise.all([
                fetch('/api/recipients-with-presents').then(r => r.json()),
                fetch('/api/user/identification').then(r => r.json())
            ])
                .then(([data, identificationStatus]) => {
                    const presents = data.presents || [];
                    const recipients = data.recipients || [];
                    const userId = identificationStatus.userId;

                    // Filter for presents reserved by current user
                    const myReservations = presents.filter(p =>
                        p.reserved_by === userId && !p.is_checked
                    );

                    renderPresentsList(myReservations, recipients, 'myReservationsList', 'Brak zarezerwowanych prezent贸w');
                })
                .catch(error => console.error('Error loading reservations:', error));
        }

        function loadBoughtPresents() {
            Promise.all([
                fetch('/api/recipients-with-presents').then(r => r.json()),
                fetch('/api/user/identification').then(r => r.json())
            ])
                .then(([data, identificationStatus]) => {
                    const presents = data.presents || [];
                    const recipients = data.recipients || [];
                    const userId = identificationStatus.userId;

                    // Filter for bought presents reserved by current user
                    const boughtPresents = presents.filter(p =>
                        p.reserved_by === userId && p.is_checked
                    );

                    renderPresentsList(boughtPresents, recipients, 'boughtPresentsList', 'Brak kupionych prezent贸w');
                })
                .catch(error => console.error('Error loading bought presents:', error));
        }

        function renderPresentsList(presents, recipients, containerId, emptyMessage) {
            const container = document.getElementById(containerId);

            if (presents.length === 0) {
                container.innerHTML = `<div class="text-center py-5"><p class="text-muted">${emptyMessage}</p></div>`;
                return;
            }

            const presentsByRecipient = {};
            presents.forEach(present => {
                if (!presentsByRecipient[present.recipient_id]) {
                    presentsByRecipient[present.recipient_id] = [];
                }
                presentsByRecipient[present.recipient_id].push(present);
            });

            let html = '';
            Object.keys(presentsByRecipient).forEach(recipientId => {
                const recipient = recipients.find(r => r.id == recipientId);
                if (!recipient) return;

                const recipientPresents = presentsByRecipient[recipientId];

                const avatarHTML = recipient.profile_picture
                    ? `<img src="/api/recipients/${recipient.id}/profile-picture" 
                           alt="${escapeHtml(recipient.name)}" 
                           style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer;"
                           onclick="openProfilePicturePreview(${recipient.id}, '${escapeHtml(recipient.name).replace(/'/g, "\\'")}', '/api/recipients/${recipient.id}/profile-picture')"
                           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div style="display: none; width: 40px; height: 40px; align-items: center; justify-content: center; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; flex-shrink: 0;">
                           ${getEmojiAvatar(recipient.name)}
                       </div>`
                    : `<div style="display: flex; width: 40px; height: 40px; align-items: center; justify-content: center; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; flex-shrink: 0;">
                           ${getEmojiAvatar(recipient.name)}
                       </div>`;

                html += `
                    <div style="margin-bottom: 25px; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h5 style="color: #2d3748; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            ${avatarHTML}
                            ${escapeHtml(recipient.name)}
                            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 500;">
                                ${recipientPresents.length} ${recipientPresents.length === 1 ? 'prezent' : 'prezent贸w'}
                            </span>
                        </h5>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${recipientPresents.map(present => `
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid ${present.is_checked ? '#4CAF50' : '#FF9800'};">
                                    <div style="display: flex; gap: 8px; flex: 1; min-width: 0;">
                                        <i class="fas fa-gift" style="color: ${present.is_checked ? '#4CAF50' : '#FF9800'}; margin-top: 2px; flex-shrink: 0;"></i>
                                        <div style="flex: 1; min-width: 0;">
                                            <div style="font-weight: 500; color: #2d3748; margin-bottom: 4px; word-wrap: break-word; overflow-wrap: break-word;">
                                                ${makeLinksClickable(escapeHtml(present.title))}
                                            </div>
                                            ${present.comments ? `
                                                <div style="font-size: 13px; color: #718096; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">
                                                    ${makeLinksClickable(escapeHtml(present.comments))}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 6px; flex-shrink: 0;">
                                        ${present.is_checked ? `
                                            <button class="btn btn-sm btn-outline-danger" onclick="markAsUnbought(${present.id})" style="white-space: nowrap; padding: 6px 16px; font-size: 13px;">
                                                <i class="fas fa-undo me-1"></i>Anuluj Zakup
                                            </button>
                                        ` : `
                                            <button class="btn btn-sm btn-success" onclick="markAsBought(${present.id})" style="white-space: nowrap; padding: 6px 16px; font-size: 13px;">
                                                <i class="fas fa-check me-1"></i>Kupione
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="unreservePresent(event, ${present.id})" style="white-space: nowrap; padding: 6px 16px; font-size: 13px;">
                                                <i class="fas fa-times me-1"></i>Anuluj
                                            </button>
                                        `}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Wrapper functions for statystyki page that call API and reload sections
        function reservePresent(event, presentId) {
            // Find and disable the button
            const button = event.target.closest('button');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rezerwuj...';
            }

            fetch(`/api/presents/${presentId}/reserve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Change button to "Anuluj" so user can cancel reservation
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-times me-1"></i>Anuluj';
                            button.className = 'btn btn-sm';
                            button.style.cssText = 'white-space: nowrap; padding: 6px 16px; font-size: 13px; flex-shrink: 0; color: #dc3545; border-color: #dc3545; border: 2px solid #dc3545;';
                            button.onclick = function(e) { unreservePresent(e, presentId); };
                        }
                        // Update stats without reloading the whole page
                        loadStats();
                    } else {
                        alert('Bd: ' + (data.error || 'Nie udao si zarezerwowa prezentu'));
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-bookmark me-1"></i>Zarezerwuj';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystpi bd podczas rezerwowania prezentu');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-bookmark me-1"></i>Zarezerwuj';
                    }
                });
        }

        function unreservePresent(event, presentId) {
            // Find and disable the button
            const button = event.target.closest('button');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Anulowanie...';
            }

            fetch(`/api/presents/${presentId}/reserve`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Change button back to "Zarezerwuj"
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-bookmark me-1"></i>Zarezerwuj';
                            button.className = 'btn btn-sm';
                            button.style.cssText = 'white-space: nowrap; padding: 6px 16px; font-size: 13px; flex-shrink: 0; color: #ffcc00; border-color: #ffc107; border: 2px solid #ffcc00;';
                            button.onclick = function(e) { reservePresent(e, presentId); };
                        }
                        // Update stats without reloading the whole page
                        loadStats();
                    } else {
                        alert('Bd: ' + (data.error || 'Nie udao si anulowa rezerwacji'));
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-times me-1"></i>Anuluj';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Wystpi bd podczas anulowania rezerwacji');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-times me-1"></i>Anuluj';
                    }
                });
        }

        function openProfilePicturePreview(recipientId, recipientName, profilePictureUrl) {
            const modal = document.getElementById('profilePreviewModal');
            const previewImage = document.getElementById('profilePreviewImage');
            const previewName = document.getElementById('profilePreviewName');

            if (modal && previewImage && previewName) {
                previewImage.src = profilePictureUrl;
                previewName.textContent = recipientName;

                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
            }
        }

        function markAsBought(presentId) {
            // Find the button and show spinner
            const button = event.target.closest('button');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Zapisywanie...';
            }

            fetch(`/api/presents/${presentId}/check`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_checked: true })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload sections to move present to "Bought" bucket
                        loadMyReservations();
                        loadBoughtPresents();
                        loadStats();
                    } else {
                        alert('Bd: ' + (data.error || 'Nie udao si oznaczy prezentu'));
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-check me-1"></i>Kupione';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error marking as bought:', error);
                    alert('Wystpi bd podczas oznaczania prezentu');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-check me-1"></i>Kupione';
                    }
                });
        }

        function markAsUnbought(presentId) {
            fetch(`/api/presents/${presentId}/check`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_checked: false })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload sections to move present back to "Reserved" bucket
                        loadMyReservations();
                        loadBoughtPresents();
                        loadStats();
                    }
                })
                .catch(error => console.error('Error unmarking as bought:', error));
        }

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    // Clear local storage
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/';
                })
                .catch(() => {
                    // Even if logout fails, redirect to login
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/';
                });
        }

        loadStats();
    </script>

    <!-- Bottom Tab Bar -->
    <div class="bottom-tab-bar">
        <div class="tab-bar-container">
            <a href="/" class="tab-item home-tab active">
                <i class="ri-home-line"></i>
                <span>Strona G贸wna</span>
            </a>
            <a href="#" class="tab-item activity-tab" onclick="toggleNotificationsPanel(); return false;">
                <div class="tab-icon-wrapper">
                    <i class="ri-notification-3-line"></i>
                    <span class="notification-badge" id="activityBadge" style="display: none;"></span>
                </div>
                <span>Aktywno</span>
            </a>
            <div class="tab-spacer"></div>
            <a href="leaderboard.html" class="tab-item leaderboard-tab">
                <i class="ri-trophy-line"></i>
                <span>Ranking</span>
            </a>
            <a href="formularz.html" class="tab-item form-tab">
                <i class="ri-file-list-3-line"></i>
                <span>Dodaj Prezent</span>
            </a>
        </div>
        <div class="tab-fab" onclick="toggleTabBarMenu()">
            <i class="ri-menu-line"></i>
        </div>
    </div>

    <div class="tab-bar-menu-overlay" id="tabBarOverlay" onclick="closeAllPanels()"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9998; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; pointer-events: none;">
    </div>

    <div class="tab-bar-menu-panel" id="tabBarMenuPanel">
        <div class="tab-bar-menu-header">
            <h5><i class="ri-menu-line me-2"></i>Menu</h5>
            <button class="tab-bar-menu-close" onclick="toggleTabBarMenu()">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="tab-bar-menu-content">
            <div class="tab-bar-menu-divider"></div>
            <a href="recipients.html" class="tab-bar-menu-item">
                <i class="ri-gift-2-line"></i>
                <span>Wszystkie prezenty</span>
            </a>
            <a href="recipients.html" class="tab-bar-menu-item add-person-item">
                <i class="ri-user-add-line"></i>
                <span>Dodaj Osob</span>
            </a>
            <a href="formularz.html" class="tab-bar-menu-item add-present-item">
                <i class="ri-gift-line"></i>
                <span>Dodaj Prezent</span>
            </a>
            <a href="recipients.html" class="tab-bar-menu-item reserved-item">
                <i class="ri-bookmark-line"></i>
                <span>Zarezerwowane Prezenty</span>
            </a>
            <a href="formularz.html" class="tab-bar-menu-item edit-presents-item"
                onclick="localStorage.setItem('openEditTab', 'true');">
                <i class="ri-edit-line"></i>
                <span>Edytuj Moje Prezenty</span>
            </a>
            <div class="tab-bar-menu-divider"></div>
            <a href="#" class="tab-bar-menu-item settings-item"
                onclick="alert('Funkcja ustawie bdzie dostpna wkr贸tce!'); toggleTabBarMenu(); return false;">
                <i class="ri-settings-3-line"></i>
                <span>Ustawienia</span>
            </a>
            <a href="#" class="tab-bar-menu-item logout-item" onclick="logout(); return false;">
                <i class="ri-logout-box-r-line"></i>
                <span>Wyloguj</span>
            </a>
        </div>
    </div>

    <div class="tab-bar-notifications-panel" id="notificationsPanel"
        style="position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background: #ffffff; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3); z-index: 9999; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); max-height: 70vh; min-height: 300px; display: flex; flex-direction: column; overflow: hidden;">
        <div class="tab-bar-notifications-header"
            style="padding: 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; background: #ffffff; flex-shrink: 0; border-top-left-radius: 20px; border-top-right-radius: 20px;">
            <h5 style="margin: 0; color: #2d3748; font-weight: 600; font-size: 18px;"><i
                    class="ri-notification-3-line me-2"></i>Powiadomienia</h5>
            <button class="tab-bar-notifications-close" onclick="toggleNotificationsPanel()"
                style="background: rgba(0, 0, 0, 0.05); border: none; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #2d3748;">
                <i class="ri-close-line"></i>
            </button>
        </div>
        <div class="tab-bar-notifications-content" id="notificationsContent"
            style="flex: 1; overflow-y: auto; background: #ffffff;">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">adowanie...</span>
                </div>
            </div>
        </div>
        <div class="tab-bar-notifications-view-all"
            style="padding: 16px 20px; text-align: center; border-top: 1px solid rgba(0, 0, 0, 0.1); background: #ffffff; flex-shrink: 0;">
            <a href="activity.html"
                style="color: #2196F3; text-decoration: none; font-weight: 600; font-size: 14px;">Zobacz wszystkie
                powiadomienia</a>
        </div>
    </div>

    <!-- Self Identification Modal -->
    <div class="modal fade" id="selfIdentificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-check me-2"></i>Potwierd藕 swoj to偶samo
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="fas fa-user-circle fa-3x text-primary"></i>
                        </div>
                        <h6 class="text-muted mb-3">Czy to jeste Ty?</h6>
                        <p class="mb-0">Chcesz zidentyfikowa si jako <strong id="identificationRecipientName"
                                class="text-primary"></strong>?</p>
                        <small class="text-muted d-block mt-2">Po identyfikacji bdziesz m贸g zarzdza swoimi
                            prezentami</small>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <div class="d-flex flex-column flex-md-row gap-3 w-100 justify-content-center align-items-center">
                        <button type="button" class="btn btn-secondary btn-lg order-3 order-md-1"
                            data-bs-dismiss="modal" style="min-width: 140px;">
                            <i class="fas fa-times me-1"></i>Anuluj
                        </button>
                        <button type="button" class="btn btn-warning btn-lg order-2"
                            onclick="showRecipientSelectionModal()"
                            style="background: linear-gradient(135deg, #ffc107, #e0a800); border: 2px solid #ffc107; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); min-width: 160px;">
                            <i class="fas fa-search me-1"></i>Nie, to nie ja
                        </button>
                        <button type="button" class="btn btn-success btn-lg order-1 order-md-3"
                            onclick="confirmSelfIdentification()"
                            style="background: linear-gradient(135deg, #28a745, #1e7e34); border: 2px solid #28a745; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); min-width: 180px;">
                            <i class="fas fa-check me-1"></i>Tak, to jestem ja
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recipient Selection Modal -->
    <div class="modal fade" id="recipientSelectionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users me-2"></i>Wybierz swoje imi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="fas fa-user-plus fa-2x text-success"></i>
                        </div>
                        <h6 class="text-muted">Kt贸ra osoba to Ty?</h6>
                        <p class="text-muted mb-0">Wybierz swoje imi z listy lub dodaj nowe</p>
                    </div>

                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="fas fa-list me-2"></i>Dostpne osoby:
                        </h6>
                        <div id="availableRecipientsList" class="list-group">
                            <!-- Lista bdzie generowana dynamicznie -->
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="mb-3">
                        <h6 class="mb-3">
                            <i class="fas fa-plus-circle me-2"></i>Dodaj now osob:
                        </h6>
                        <form id="newRecipientForm">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="newRecipientName"
                                    placeholder="Wprowad藕 swoje imi i nazwisko" required
                                    style="border: 2px solid #007bff; border-radius: 8px; padding: 12px; font-size: 16px;">
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-success w-100"
                                    onclick="addNewRecipientAndIdentify()">
                                    <i class="fas fa-plus me-1"></i>Dodaj i zidentyfikuj
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2">Jeli nie widzisz swojego imienia, dodaj je
                                tutaj</small>
                        </form>
                    </div>
                    <div id="recipientSelectionMessage" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Zamknij
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Identification Modal -->
    <div class="modal fade" id="cancelIdentificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-times me-2"></i>Anuluj identyfikacj
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                        </div>
                        <h6 class="text-muted mb-3">Czy na pewno chcesz anulowa identyfikacj?</h6>
                        <p class="mb-0">Przestaniesz by zidentyfikowany jako <strong
                                id="cancelIdentificationRecipientName" class="text-primary"></strong></p>
                        <small class="text-muted d-block mt-2">Bdziesz m贸g ponownie si zidentyfikowa w ka偶dej
                            chwili</small>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Nie, zostaw
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmCancelIdentification()">
                        <i class="fas fa-check me-1"></i>Tak, anuluj
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Picture Preview Modal -->
    <div class="modal fade profile-preview-modal" id="profilePreviewModal" tabindex="-1"
        aria-labelledby="profilePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profilePreviewModalLabel">Podgld zdjcia profilowego</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="profilePreviewImage" class="profile-preview-image" alt="Zdjcie profilowe">
                    <div id="profilePreviewName" class="profile-preview-name mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Present Modal -->
    <div class="modal fade" id="editPresentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content aws-modal">
                <div class="modal-header aws-modal-header">
                    <div class="aws-modal-title-section">
                        <h5 class="modal-title">
                            <i class="fas fa-edit me-2"></i>Edytuj Prezent
                        </h5>
                        <p class="aws-modal-subtitle">Zmie informacje o prezencie</p>
                    </div>
                    <button type="button" class="btn-close aws-close-btn" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body aws-modal-body">
                    <form id="editPresentForm" class="aws-form">
                        <input type="hidden" id="editPresentId">
                        <div class="aws-form-section">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="aws-form-group">
                                        <label for="editPresentTitle" class="form-label aws-form-label">
                                            <i class="fas fa-gift me-1"></i>Jaki prezent?
                                        </label>
                                        <input type="text" class="form-control aws-form-control" id="editPresentTitle"
                                            placeholder="Wprowad藕 nazw prezentu" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="aws-form-group">
                                        <label for="editRecipientSelect" class="form-label aws-form-label">
                                            <i class="fas fa-user me-1"></i>Dla kogo?
                                        </label>
                                        <select class="form-control aws-form-control" id="editRecipientSelect" required>
                                            <option value="">Wybierz osob</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="aws-form-section">
                            <div class="aws-form-group">
                                <label for="editPresentComments" class="form-label aws-form-label">
                                    <i class="fas fa-comment me-1"></i>Dodatkowe informacje
                                </label>
                                <textarea class="form-control aws-form-control" id="editPresentComments" rows="3"
                                    placeholder="Opis, linki, uwagi, gdzie kupi..."></textarea>
                            </div>
                        </div>
                    </form>
                    <div id="editPresentMessage" class="alert aws-alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer aws-modal-footer">
                    <button type="button" class="btn aws-btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Anuluj
                    </button>
                    <button type="button" class="btn aws-btn-primary" onclick="saveEditedPresent()">
                        <i class="fas fa-save me-1"></i>Zapisz zmiany
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="tab-bar-functions.js"></script>
</body>

</html>